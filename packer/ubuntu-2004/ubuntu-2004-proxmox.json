{
  "variables": {
    "common_version": "1.0.0",
    "vm_id": "1000",
    "vm_name": "ubuntu-2004",
    "disk_size": "30G",
    "ram": "8192",
    "cpus": "8",
    "username": "{{ env `PM_API_TOKEN_ID`}}",
    "token": "{{ env `PM_API_TOKEN_SECRET` }}",
    "node_name": "pve",
    "template_description": "Ubuntu 20.04 x86_64 template built with packer"
  },

  "builders": [
    {
      "type": "proxmox",
      "boot_command": [
        "<enter><enter><f6><esc><wait> ",
        "autoinstall ds=nocloud-net;seedfrom=http://192.168.0.13:5000/",
        "<enter><wait>"
      ],
      "boot_wait": "5s",
      "proxmox_url": "https://192.168.0.73:8006/api2/json",
      "insecure_skip_tls_verify": true,
      "username": "{{user `username`}}",
      "token": "{{user `token`}}",

      "node": "{{ user `node_name`}}",

      "network_adapters": [
        {
          "bridge": "vmbr0",
          "model": "virtio"
        }
      ],

      "disks": [
        {
          "type": "scsi",
          "disk_size": "{{ user `disk_size` }}",
          "storage_pool": "local-lvm",
          "storage_pool_type": "lvm-thin",
          "format": "qcow2"
        }
      ],

      "cloud_init": true,
      "cloud_init_storage_pool": "local-lvm",
      "http_directory": "http",
      "http_port_min": 5000,
      "http_port_max": 5000,
      "iso_urls": [
        "ubuntu-20.04.3-live-server-amd64.iso",
        "https://releases.ubuntu.com/20.04/ubuntu-20.04.3-live-server-amd64.iso"
      ],
      "unmount_iso": true,
      "iso_storage_pool": "local",
      "iso_checksum": "sha256:f8e3086f3cea0fb3fefb29937ab5ed9d19e767079633960ccb50e76153effc98",
      "ssh_username": "kumori",
      "ssh_private_key_file" : "/home/kumori/.ssh/id_rsa",
      "ssh_timeout": "300m",
      "vm_name": "{{user `vm_name` }}",
      "vm_id": "{{user `vm_id`}}",
      "memory": "{{ user `ram` }}",
      "cores": "{{ user `cpus` }}",
      "os": "l26",
      "template_description":"{{user `template_description`}}"
    }
  ],

  "provisioners": [{
    "type": "shell",
    "inline": [
      "while [ ! -f /var/lib/cloud/instance/boot-finished ]; do echo 'Waiting for cloud-init...'; sleep 1; done"
    ]
  }]
}
